# 论文阅读 
## 《Label-Free Multivariate Time Series Anomaly Detection》
### 传统方法的问题：
#### 多元时间序列异常检测   
传统方法常多基于单类分类(OCC)，简单来说就是训练集全部为正样本。   
而且在现实中，训练数据往往存在噪声标签，也就是不准确的标签，这会导致模型过拟合异常，性能下降。    
  ![](https://github.com/makabal/paper/blob/main/tupian/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-10-22%20095831.png?raw=true)    
  基于此，本文提出了一种新的检测方法——MTGFlow。    
### 方法概述
![](https://github.com/makabal/paper/blob/main/tupian/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%202025-10-22%20103713.png?raw=true)
#### 传统GNN  
将GNN应用于时间序列异常检测，核心思想是：时间序列数据点之间不是独立的，它们存在着复杂的、结构化的相互关系。    
##### 1.构建图  
- 节点：通常代表多元时间序列中的每一个变量（实体）。
- 边：代表变量之间的关系或依赖。
  - 静态预定义图：根据物理连接或先验知识。
  - 动态学习图（如MTGFlow论文中所用）：使用自注意力机制等，让模型自己从数据中学习每两个变量之间的关联强度。    
##### 2.消息传递
- 初始化：每个节点用其当前时刻的时间序列值作为初始状态。
- 聚合：对于每个节点（例如“温度传感器A”），GNN会去收集其所有邻居节点（如与A相连的压力传感器B、流速传感器C）的信息。
- 更新：节点A结合自己的信息和从邻居聚合来的信息，更新自己的状态。这个新状态就包含了其邻居的上下文信息。
这个过程会进行多轮，使得信息能够在图中传播得更远。最终，每个节点都获得了一个富含其所在局部图结构信息的增强表示。   
##### 3.结合时间建模
- 图卷积 + RNN/Transformer：
  - 在每个时间步 t，使用GNN处理当前时刻的图结构数据，得到所有节点的空间增强表示。
  - 然后将每个节点的增强表示序列输入到RNN（如LSTM、GRU）或Transformer中，来捕捉其时间动态。
- 时空图神经网络
### MTGFlow模型完整流程解析

#### 步骤1：输入与滑动窗口采样

- **输入**：原始的多元时间序列数据，形状可表示为 `[总时间步数, 实体数量]`
- **预处理**：对每个实体的时间序列进行Z-score标准化
- **滑动窗口**：使用固定长度窗口（如60个时间步）和步长（如10）在时间轴上滑动，将连续时间序列切分成多个重叠的窗口样本 x^c，形状为 `[实体数量, 窗口长度]`

#### 步骤2：时空特征并行提取

这一步骤同时捕捉数据中的**时间**和**空间**依赖关系。

##### 2a. 时序特征提取（RNN/LSTM）

- **目的**：捕获每个实体**自身**在窗口内的时间依赖模式
- **操作**：将每个实体在窗口内的序列输入RNN，得到每个时间步的隐藏状态 $H^t$
- **输出**：窗口的**时间编码**

##### 2b. 动态图结构学习（自注意力）

- **目的**：捕获同一窗口内**不同实体之间**的动态依赖关系
- **操作**：将窗口数据 $x^c$ 输入自注意力模块，计算注意力分数矩阵 $A^c$
- **输出**：当前窗口的**动态邻接矩阵**，量化实体间的相互影响强度

#### 步骤3：生成时空条件

- **目的**：将**时间特征**和**空间图结构**融合成统一的上下文表示
- **操作**：对时间编码 $H^t$ 和动态邻接矩阵 $A^c$ 进行图卷积操作：

$$C^t = \text{ReLU}(A^c H^t W_1 + H^{t-1} W_2)W_3$$

- **输出**：**时空条件 $C^c$**，封装当前上下文下的正常行为模式

#### 步骤4：决策点：实体感知 vs. 集群感知

从这里开始，流程根据是否使用聚类信息而分叉。

##### 路径A：MTGFlow（实体感知）

- **理念**：认为每个实体都独一无二，应单独建模
- **操作**：将时空条件 $C^c$ 和实体数据输入**实体感知归一化流**
- **输出**：每个实体 $k$ 映射到**专属的**目标高斯分布 $\mathcal{N}(\mu_k, I)$

##### 路径B：MTGFlow_cluster（集群感知）

- **理念**：承认实体具有相似性，可分组处理提高效率
- **操作**：
  1. **聚类**：使用KShape算法将实体划分为集群
  2. **映射**：将时空条件 $C^c$ 和实体数据输入**集群感知归一化流**
- **输出**：同一集群 $m$ 内实体映射到**共享的**目标高斯分布 $\mathcal{N}(\mu_m, I)$

#### 步骤5：密度估计与联合优化

- **目的**：训练模型准确估计正常数据的概率密度
- **核心机制**：归一化流 $f_\theta$ 将原始数据 $x_k^c$ 变换到目标高斯分布空间
- **损失函数**：采用**最大似然估计**，最大化所有训练窗口数据的对数似然概率
- **特点**：所有模块参数**联合优化**，避免局部最优

#### 步骤6：异常检测与解释

- **异常评分**：计算测试窗口的**负对数似然**均值作为异常分数 $S_c$
- **阈值设定**：使用训练集异常分数，通过**IQR方法**自动计算阈值
- **异常解释**：检查**每个实体的独立异常分数 $S_{ck}$**，精确定位异常源

